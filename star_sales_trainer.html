<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>STAR Performance – Sales Objection Handling Trainer</title>
  <style>
    :root {
      --star-red: #b00020;
      --star-dark: #222222;
      --star-gray: #6d6e71;
      --star-light-gray: #f4f5f7;
      --star-border-gray: #d0d2d3;
      --star-accent: #444444;
      --white: #ffffff;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--star-light-gray);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
    }

    .app-container {
      margin: 24px;
      max-width: 980px;
      width: 100%;
      background: var(--white);
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
      padding: 20px 24px 18px 24px;
      box-sizing: border-box;
    }

    /* Header / Branding */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      border-bottom: 3px solid var(--star-red);
      padding-bottom: 10px;
      margin-bottom: 16px;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-main {
      height: 52px;
      max-width: 260px;
    }
    .app-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .app-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--star-dark);
    }
    .app-subtitle {
      font-size: 0.9rem;
      color: var(--star-gray);
    }
    .header-right img {
      height: 70px;
      max-width: 140px;
    }

    /* Layout Sections */
    .top-row {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 16px;
      margin-bottom: 12px;
    }

    h2, h3 {
      margin: 0 0 6px 0;
      color: var(--star-dark);
    }

    .section-card {
      background: #fafbfc;
      border-radius: 6px;
      border: 1px solid var(--star-border-gray);
      padding: 10px 12px;
      box-sizing: border-box;
    }

    #scenarioTitle {
      font-weight: bold;
      margin-bottom: 4px;
      color: var(--star-dark);
    }

    #scenarioDescription {
      font-size: 0.92rem;
      color: #444;
      margin-bottom: 4px;
    }

    .week-label {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--star-gray);
      margin-bottom: 4px;
    }

    .star-hints-list {
      font-size: 0.86rem;
      color: #333;
      padding-left: 16px;
      margin: 4px 0 0 0;
    }
    .star-hints-list li {
      margin-bottom: 3px;
    }
    .star-hints-keyword {
      font-weight: bold;
      color: var(--star-red);
    }

    /* Conversation Area */
    #conversation {
      background: #ffffff;
      border: 1px solid var(--star-border-gray);
      border-radius: 6px;
      padding: 12px;
      height: 320px;
      overflow-y: auto;
      font-size: 0.95rem;
      margin-bottom: 8px;
    }

    .message {
      margin-bottom: 10px;
      line-height: 1.4;
    }
    .message.system {
      color: var(--star-gray);
      font-style: italic;
    }
    .message.customer {
      color: var(--star-red);
    }
    .message.rep {
      color: #1a73e8;
    }
    .message.outcome {
      font-weight: bold;
      color: var(--star-dark);
    }

    .label {
      font-size: 0.85rem;
      font-weight: bold;
      margin-top: 4px;
      margin-bottom: 4px;
      color: var(--star-accent);
    }

    #options {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .option-btn {
      text-align: left;
      padding: 8px 10px;
      border-radius: 4px;
      border: 1px solid var(--star-border-gray);
      background: #fdfdfd;
      cursor: pointer;
      font-size: 0.92rem;
      color: var(--star-dark); /* visible text */
    }

    .option-btn:hover {
      border-color: var(--star-red);
      background: #fff5f5;
    }

    .option-good { border-left: 4px solid #4caf50; }
    .option-better { border-left: 4px solid #2196f3; }
    .option-best { border-left: 4px solid #ff9800; }
    .option-wrong { border-left: 4px solid #9e9e9e; }

    #playerName {
      width: 260px;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid var(--star-border-gray);
      font-size: 0.9rem;
      margin-right: 8px;
    }

    button {
      padding: 8px 14px;
      border-radius: 4px;
      border: none;
      background: var(--star-red);
      color: var(--white);
      font-size: 0.95rem;
      cursor: pointer;
      font-weight: 600;
    }

    button:disabled {
      background: #a0a0a0;
      cursor: not-allowed;
    }

    #statusBar {
      margin-top: 6px;
      font-size: 0.88rem;
      color: var(--star-accent);
    }

    #liveHintTitle {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--star-gray);
      margin-top: 6px;
    }

    #hint {
      margin-top: 2px;
      font-size: 0.86rem;
      color: #555;
    }

    #resetBtn {
      margin-top: 10px;
      background: var(--star-dark);
    }

    /* Leaderboard */
    .leaderboard-section {
      margin-top: 14px;
      padding: 10px 12px;
      background: #fafbfc;
      border-radius: 6px;
      border: 1px solid var(--star-border-gray);
      font-size: 0.88rem;
    }
    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 8px;
    }
    #leaderboardList {
      margin: 6px 0 4px 18px;
      padding: 0;
    }
    #leaderboardList li {
      margin-bottom: 2px;
    }
    #previousWinner {
      margin-top: 4px;
      font-size: 0.8rem;
      color: var(--star-gray);
    }
    #trialNote {
      margin-top: 6px;
      font-size: 0.78rem;
      color: #555;
      font-style: italic;
    }

    .footer {
      margin-top: 12px;
      font-size: 0.8rem;
      color: var(--star-gray);
      text-align: right;
    }

    @media (max-width: 800px) {
      .top-row {
        grid-template-columns: 1fr;
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        align-self: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- HEADER -->
    <header class="header">
      <div class="header-left">
        <img src="StarPerformance_Logo_3C.png" alt="Star Performance Logo" class="logo-main" />
        <div class="app-title-block">
          <div class="app-title">Sales Objection Handling Trainer</div>
          <div class="app-subtitle">Practice difficult conversations the STAR Performance way.</div>
        </div>
      </div>
      <div class="header-right">
        <img src="Star_Performance_Graphic-Icon-One Word.png" alt="Star Performance Icon" />
      </div>
    </header>

    <!-- TOP ROW -->
    <div class="top-row">
      <div class="section-card">
        <div class="week-label" id="weekLabel"></div>
        <h2>This Scenario</h2>
        <div id="scenarioTitle"></div>
        <div id="scenarioDescription"></div>

        <h3>Goal</h3>
        <p style="font-size:0.92rem; margin:0;">
          Build trust, explore needs, manage price &amp; timing concerns, and confidently Earn the close using STAR.
        </p>
      </div>

      <div class="section-card">
        <h2>STAR Performance Hints</h2>
        <p style="font-size:0.9rem; margin-bottom:4px;">
          Use the STAR model to keep the conversation moving toward a decision:
        </p>
        <ul class="star-hints-list">
          <li><span class="star-hints-keyword">Seek</span> – Open with curiosity. Ask about goals, current situation, and what “success” looks like.</li>
          <li><span class="star-hints-keyword">Ask</span> – Ask focused questions to uncover true objections (price, timing, risk, decision maker, etc.).</li>
          <li><span class="star-hints-keyword">Leverage</span> – Connect your solution to what they value most: outcomes, ROI, reduced risk, or time saved.</li>
          <li><span class="star-hints-keyword">Earn</span> – Earn the right to ask for the business by summarizing fit and checking for alignment.</li>
          <li><span class="star-hints-keyword">Serve</span> – Help them decide. Offer clear next steps that make it easy to move forward.</li>
        </ul>
        <p style="font-size:0.8rem; color:#777; margin-top:6px;">
          As you click responses below, notice how each option reflects (or ignores) Seek, Ask, Leverage, Earn, and Serve.
        </p>
      </div>
    </div>

    <!-- NAME + CONVERSATION -->
    <div class="label">Your Name (for leaderboard):</div>
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
      <input type="text" id="playerName" placeholder="First name or initials..." />
      <button id="saveScoreBtn" disabled style="padding:6px 10px; font-size:0.85rem;">Save Last Score to Leaderboard</button>
    </div>

    <div id="conversation"></div>

    <div class="label">Choose Your Response:</div>
    <div id="options"></div>

    <div id="statusBar"></div>
    <div id="liveHintTitle">Live Coaching Hint</div>
    <div id="hint"></div>

    <button id="resetBtn">Restart Scenario</button>

    <!-- LEADERBOARD -->
    <div class="leaderboard-section">
      <div class="leaderboard-header">
        <h2 style="margin:0;">Weekly Trial Leaderboard</h2>
        <span id="currentWeekLabel" style="font-size:0.8rem; color:#777;"></span>
      </div>
      <ol id="leaderboardList"></ol>
      <div id="previousWinner"></div>
      <div id="trialNote">
        Trials run Friday 12:00 a.m. through Thursday 11:59 p.m. Your first score of each trial is locked in.
        You can replay for practice, but only your first score counts on the leaderboard.
      </div>
    </div>

    <div class="footer">
      STAR Performance – Practice, reflect, and run it again with a different approach.
    </div>
  </div>

  <script>
    // ===== DOM ELEMENTS =====
    const conversationEl = document.getElementById('conversation');
    const optionsEl = document.getElementById('options');
    const statusBarEl = document.getElementById('statusBar');
    const hintEl = document.getElementById('hint');
    const playerNameInput = document.getElementById('playerName');
    const saveScoreBtn = document.getElementById('saveScoreBtn');
    const resetBtn = document.getElementById('resetBtn');
    const weekLabelEl = document.getElementById('weekLabel');
    const scenarioTitleEl = document.getElementById('scenarioTitle');
    const scenarioDescriptionEl = document.getElementById('scenarioDescription');
    const currentWeekLabelEl = document.getElementById('currentWeekLabel');
    const leaderboardListEl = document.getElementById('leaderboardList');
    const previousWinnerEl = document.getElementById('previousWinner');

    // ===== TRIAL (FRI–THU) HELPERS =====
    function getTrialStart(date) {
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = d.getDay(); // 0=Sun, 5=Fri
      const diff = (day - 5 + 7) % 7; // days since last Friday
      d.setDate(d.getDate() - diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function formatDateShort(d) {
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return months[d.getMonth()] + ' ' + String(d.getDate()).padStart(2, '0');
    }

    function getTrialInfo(date) {
      const start = getTrialStart(date);
      const end = new Date(start);
      end.setDate(start.getDate() + 6); // Fri + 6 = Thu
      const id = 'trial-' +
        start.getFullYear() + '-' +
        String(start.getMonth() + 1).padStart(2, '0') + '-' +
        String(start.getDate()).padStart(2, '0');
      return { id, start, end };
    }

    function getPreviousTrialInfo(date) {
      const current = getTrialInfo(date);
      const prevStart = new Date(current.start);
      prevStart.setDate(prevStart.getDate() - 7);
      const prevEnd = new Date(prevStart);
      prevEnd.setDate(prevStart.getDate() + 6);
      const id = 'trial-' +
        prevStart.getFullYear() + '-' +
        String(prevStart.getMonth() + 1).padStart(2, '0') + '-' +
        String(prevStart.getDate()).padStart(2, '0');
      return { id, start: prevStart, end: prevEnd };
    }

    // ===== LEADERBOARD STORAGE =====
    const LEADERBOARD_KEY = 'starTrainerLeaderboard_MC_trial_v1';

    function getLeaderboardData() {
      try {
        const raw = localStorage.getItem(LEADERBOARD_KEY);
        if (!raw) return {};
        return JSON.parse(raw);
      } catch {
        return {};
      }
    }

    function setLeaderboardData(data) {
      try {
        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(data));
      } catch {
        // ignore
      }
    }

    function getTopPlayers(trialId, limit = 5) {
      const data = getLeaderboardData();
      const entries = Array.isArray(data[trialId]) ? data[trialId] : [];
      const sorted = entries.slice().sort((a, b) => b.score - a.score);
      return sorted.slice(0, limit);
    }

    function recordScore(playerName, score, outcome) {
      if (!playerName) return false;
      const now = new Date();
      const trialInfo = getTrialInfo(now);
      const trialId = trialInfo.id;

      const data = getLeaderboardData();
      if (!Array.isArray(data[trialId])) data[trialId] = [];

      const nameLower = playerName.toLowerCase();
      const existingIndex = data[trialId].findIndex(e => e.name.toLowerCase() === nameLower);

      // FIRST SCORE ONLY: if already exists, do NOT overwrite
      if (existingIndex >= 0) {
        setLeaderboardData(data);
        renderLeaderboard();
        return false; // not accepted
      }

      data[trialId].push({
        name: playerName,
        score,
        outcome,
        date: now.toISOString()
      });
      setLeaderboardData(data);
      renderLeaderboard();
      return true; // accepted
    }

    function renderLeaderboard() {
      const now = new Date();
      const trialInfo = getTrialInfo(now);
      const trialId = trialInfo.id;

      currentWeekLabelEl.textContent = `Trial: ${trialId}`;

      const top = getTopPlayers(trialId, 5);
      leaderboardListEl.innerHTML = '';
      if (top.length === 0) {
        const li = document.createElement('li');
        li.textContent = 'No scores yet this trial – be the first to practice!';
        leaderboardListEl.appendChild(li);
      } else {
        top.forEach(entry => {
          const li = document.createElement('li');
          li.textContent = `${entry.name} – ${entry.score} pts (${entry.outcome})`;
          leaderboardListEl.appendChild(li);
        });
      }

      const prevInfo = getPreviousTrialInfo(now);
      const prevTop = getTopPlayers(prevInfo.id, 1);
      if (prevTop.length > 0) {
        const winner = prevTop[0];
        previousWinnerEl.textContent =
          `Last trial’s top score (${formatDateShort(prevInfo.start)}–${formatDateShort(prevInfo.end)}): ${winner.name} with ${winner.score} pts.`;
      } else {
        previousWinnerEl.textContent =
          'No scores recorded in the previous trial (in this browser).';
      }
    }

    // ===== SCENARIO DEFINITION (BRANCHING, MC) =====
    const scenario = {
      title: 'New Customer – Price & Timing Objections',
      description:
        'A new prospect is interested but unsure. They are worried about the investment and whether now is the right time to change. Use STAR to guide them toward a clear decision.',
      startState: 'opening',
      states: {
        opening: {
          customer: 'Customer: "We’ve been thinking about improving this area of our business, but I’m not sure if now is the right time or if the cost will really pay off."',
          hint: 'Seek + Ask: Show empathy and ask an open question about their situation or success criteria.',
          options: [
            {
              id: 'open_best',
              label: '“Totally get that. What’s not working today, and what would a successful first year look like for you?”',
              type: 'best',
              points: 30,
              next: 'discovery',
              customerReply: 'Customer: "That’s fair. Right now it’s inconsistency and wasted time. I just don’t want to spend money and regret it in a year."',
              coach: 'Best: You acknowledged their concern (Seek) and asked a clear question to define success (Ask).'
            },
            {
              id: 'open_better',
              label: '“I completely get that. What’s driving you to even look at changes right now?”',
              type: 'better',
              points: 20,
              next: 'discovery',
              customerReply: 'Customer: "Mainly the inconsistency and wasted time. I just don’t want to spend money and regret it in a year."',
              coach: 'Better: You show understanding and ask a focused question, but you don’t yet define what “success” looks like.'
            },
            {
              id: 'open_good',
              label: '“I hear you. Can you tell me a bit more about what’s happening today?”',
              type: 'good',
              points: 10,
              next: 'discovery',
              customerReply: 'Customer: "Mostly, we’re dealing with inconsistency and wasted time, and I don’t want to invest in something that doesn’t fix it."',
              coach: 'Good: You’re exploring their current situation, but you could also ask what a win would look like.'
            },
            {
              id: 'open_wrong_push_close',
              label: '“If you sign this month, I can likely get you a discount and we can get started.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "That feels rushed. If this is about pushing a deal instead of understanding us, I think we’ll pass for now."',
              coach: 'Wrong: You jumped to price and close without Seek or Ask. In real life, this often shuts down the conversation.'
            },
            {
              id: 'open_wrong_surface',
              label: '“Most of our customers see great results, so I’m sure it will work out.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "I’m sure they do, but I don’t feel like you understand our situation. Let’s pause here."',
              coach: 'Wrong: Talking about other customers without connecting to their specific situation skips Seek and Ask.'
            }
          ]
        },

        discovery: {
          customer: 'Customer: "We’re dealing with inconsistency and wasted time, and I don’t want to invest in something that doesn’t fix it."',
          hint: 'Ask + Leverage: Explore impact and connect to outcomes they care about.',
          options: [
            {
              id: 'disc_best',
              label: '“That makes sense. Roughly how much time is this costing your team each week, and what would it mean if we cut that in half?”',
              type: 'best',
              points: 30,
              next: 'price',
              customerReply: 'Customer: "It’s probably several hours a week. If we cut that in half, that would definitely help justify the cost."',
              coach: 'Best: You quantify impact and link it to outcomes (Leverage), not just features.'
            },
            {
              id: 'disc_better',
              label: '“If nothing changes over the next 6–12 months, what does that look like for you and your team?”',
              type: 'better',
              points: 20,
              next: 'price',
              customerReply: 'Customer: "More of the same—wasted time and frustration. That’s part of why we’re even talking."',
              coach: 'Better: You explore the cost of doing nothing, which helps build urgency.'
            },
            {
              id: 'disc_good',
              label: '“Where are you seeing the most inconsistency right now?”',
              type: 'good',
              points: 10,
              next: 'price',
              customerReply: 'Customer: "Mostly in how things are handled from person to person. It wastes time and creates confusion."',
              coach: 'Good: You’re still in Seek/Ask mode, learning where the pain shows up.'
            },
            {
              id: 'disc_wrong_feature_dump',
              label: '“Let me walk you through our features. We have a lot that could help.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "I don’t have time for a full tour right now. I’m not sure this is the right fit."',
              coach: 'Wrong: Jumping into a feature dump before tying to outcomes often loses engagement.'
            },
            {
              id: 'disc_wrong_price_only',
              label: '“If I could get you a really aggressive price, would that fix it?”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "Price isn’t my only concern. I’m going to hold off for now."',
              coach: 'Wrong: Focusing on price alone ignores their deeper concerns and skips Leverage.'
            }
          ]
        },

        price: {
          customer: 'Customer: "I hear you, but I’m still worried about the price and whether the return will be there."',
          hint: 'Leverage: Shift from cost to value, talk about outcomes and ROI.',
          options: [
            {
              id: 'price_best',
              label: '“That’s fair. If we could show a clear ROI within 6–12 months by reducing that wasted time, would that help you feel confident about the investment?”',
              type: 'best',
              points: 30,
              next: 'timing',
              customerReply: 'Customer: "Yes, if we saw a clear ROI in that window, I’d feel much better about the price."',
              coach: 'Best: You stay on value/ROI and test what would make the investment feel right.'
            },
            {
              id: 'price_better',
              label: '“When you think about price, what would make this feel like a strong investment rather than a risk?”',
              type: 'better',
              points: 20,
              next: 'timing',
              customerReply: 'Customer: "If I could see that it reduces wasted time and problems enough to clearly justify the spend, I’d be open."',
              coach: 'Better: You Ask what “good” looks like financially, which helps you tailor your Leverage later.'
            },
            {
              id: 'price_good',
              label: '“Let’s talk through where you’d expect to see results and how we’ll measure them together.”',
              type: 'good',
              points: 10,
              next: 'timing',
              customerReply: 'Customer: "Okay, that would help me understand the value better."',
              coach: 'Good: You’re still in Leverage mode, connecting your solution to measurable results.'
            },
            {
              id: 'price_wrong_discount',
              label: '“I can probably knock 15% off if you sign this week.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "That feels like you’re just trying to close me. I’m not comfortable moving forward."',
              coach: 'Wrong: Leading with discount undermines value and can feel pushy.'
            },
            {
              id: 'price_wrong_defensive',
              label: '“Our price is very competitive; that’s just what it costs.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "If that’s the answer, I don’t think this is the right time for us."',
              coach: 'Wrong: Being defensive on price without discussing outcomes or options doesn’t move the conversation forward.'
            }
          ]
        },

        timing: {
          customer: 'Customer: "Even if the value is there, I’m not sure now is the right time. We have a lot going on."',
          hint: 'Ask + Leverage: Explore timing and the cost of waiting; consider a phased approach.',
          options: [
            {
              id: 'time_best',
              label: '“I hear you. If nothing changes over the next 6–12 months, what’s the impact? And if we phased the rollout so it felt manageable, would that make the timing feel better?”',
              type: 'best',
              points: 30,
              next: 'close',
              customerReply: 'Customer: "If nothing changes, we keep wasting time. A phased rollout could definitely make this feel more realistic."',
              coach: 'Best: You acknowledge their concern, explore cost of waiting, and offer a Serve-minded phased rollout.'
            },
            {
              id: 'time_better',
              label: '“What else is competing for priority right now, and how does this stack up against those priorities?”',
              type: 'better',
              points: 20,
              next: 'close',
              customerReply: 'Customer: "We have other projects, but this problem keeps coming up, so it probably belongs near the top."',
              coach: 'Better: You Ask about relative priority, which helps them see where this fits.'
            },
            {
              id: 'time_good',
              label: '“Tell me what would need to be true for the timing to feel right.”',
              type: 'good',
              points: 10,
              next: 'close',
              customerReply: 'Customer: "We’d need to know the rollout won’t overwhelm the team and that we have support."',
              coach: 'Good: You invite them to define good timing, which you can then Serve toward.'
            },
            {
              id: 'time_wrong_delay',
              label: '“No problem, we can just reconnect in six months.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "Honestly, if we wait that long I’ll probably move on to other priorities. Let’s just leave it for now."',
              coach: 'Wrong: You accepted a vague delay instead of exploring timing and cost of waiting.'
            },
            {
              id: 'time_wrong_push',
              label: '“If it’s important, you’ll make time for it.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "That feels a bit harsh. I don’t think this is a fit."',
              coach: 'Wrong: This response creates friction instead of Serving them through their concern.'
            }
          ]
        },

        close: {
          customer: 'Customer: "If we can roll it out in a manageable way and see the value, I’d be open to it."',
          hint: 'Earn + Serve: Summarize the fit and ask for a clear next step/commitment.',
          options: [
            {
              id: 'close_best',
              label: '“Based on what you shared, reducing wasted time and improving consistency are top priorities, and a phased rollout with clear checkpoints hits those. The next step is getting the agreement in front of you—are you comfortable if I send it today?”',
              type: 'best',
              points: 30,
              outcome: 'won',
              customerReply: 'Customer: "Yes, that feels right. Send it over and we’ll get started."',
              coach: 'Best: You summarized (Earn), clarified value, and Asked for a specific next step (Serve).'
            },
            {
              id: 'close_better',
              label: '“From our conversation, it seems like this addresses your main issues and the timing can work with a phased start. Would you be open to reviewing an agreement so we can move this forward?”',
              type: 'better',
              points: 20,
              outcome: 'won',
              customerReply: 'Customer: "Yes, send the agreement and I’ll review it."',
              coach: 'Better: You summarize and ask for movement, though the ask is a bit softer.'
            },
            {
              id: 'close_good',
              label: '“It sounds like this could be a good fit. What would you like the next step to be?”',
              type: 'good',
              points: 10,
              outcome: 'won',
              customerReply: 'Customer: "Let’s look at an agreement and make sure the details line up."',
              coach: 'Good: You invite them to define the next step, but you could be more specific and confident.'
            },
            {
              id: 'close_wrong_no_ask',
              label: '“I’ll email you some information and you can reach out if you’d like to move forward.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "Okay, send it over. I’ll take a look if I get time." (You never hear back.)',
              coach: 'Wrong: No clear ask or next step – this often leads to no decision.'
            },
            {
              id: 'close_wrong_pressure',
              label: '“We really need to get this signed today to hold pricing.”',
              type: 'wrong',
              points: 0,
              outcome: 'lost',
              customerReply: 'Customer: "That feels like pressure. I’m not comfortable moving ahead."',
              coach: 'Wrong: High-pressure tactics can undo the trust you’ve built.'
            }
          ]
        }
      }
    };

    // ===== CONVERSATION / SCORING STATE =====
    let currentStateId = scenario.startState;
    let strongMoves = 0;
    let qualityPoints = 0;
    let repTurns = 0;
    let lastScore = null;
    let lastOutcome = null;

    function addMessage(text, type = 'system') {
      const div = document.createElement('div');
      div.classList.add('message', type);
      div.textContent = text;
      conversationEl.appendChild(div);
      conversationEl.scrollTop = conversationEl.scrollHeight;
    }

    function setStatus(text) {
      statusBarEl.textContent = text;
    }

    function setHint(text) {
      hintEl.textContent = text;
    }

    function clearOptions() {
      optionsEl.innerHTML = '';
    }

    function shuffleArray(arr) {
      const copy = arr.slice();
      for (let i = copy.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [copy[i], copy[j]] = [copy[j], copy[i]];
      }
      return copy;
    }

    function renderState(stateId) {
      currentStateId = stateId;
      const state = scenario.states[stateId];
      if (!state) return;

      clearOptions();
      addMessage(state.customer, 'customer');
      setHint(state.hint || '');

      const shuffledOptions = shuffleArray(state.options);

      shuffledOptions.forEach(opt => {
        const btn = document.createElement('button');
        btn.classList.add('option-btn');
        if (opt.type === 'good') btn.classList.add('option-good');
        if (opt.type === 'better') btn.classList.add('option-better');
        if (opt.type === 'best') btn.classList.add('option-best');
        if (opt.type === 'wrong') btn.classList.add('option-wrong');

        btn.textContent = opt.label;
        btn.addEventListener('click', () => handleOptionClick(opt));
        optionsEl.appendChild(btn);
      });
    }

    function calculateScore(outcome) {
      let score = 0;
      score += (outcome === 'won' ? 50 : 10);  // outcome bonus
      score += qualityPoints;                  // points from answer quality
      score -= repTurns * 2;                   // efficiency penalty
      if (score < 0) score = 0;
      return score;
    }

    function endScenario(outcome) {
      Array.from(optionsEl.querySelectorAll('button')).forEach(b => (b.disabled = true));

      const score = calculateScore(outcome);
      lastScore = score;
      lastOutcome = outcome;
      saveScoreBtn.disabled = false;

      addMessage(`Your Score: ${score} points`, 'system');
      addMessage(
        `(Quality points: ${qualityPoints}, Efficiency penalty: -${repTurns * 2}, Outcome bonus: ${
          outcome === 'won' ? 50 : 10
        })`,
        'system'
      );

      const name = playerNameInput.value.trim();
      if (name) {
        const accepted = recordScore(name, score, outcome);
        if (accepted) {
          setStatus(
            `Result: Close ${outcome === 'won' ? 'Won ✅' : 'Lost ❌'} | Score saved as: ${name}. ` +
            'Your first score of the week is locked in. Play again for practice, but only your first score counts.'
          );
        } else {
          setStatus(
            `Result: Close ${outcome === 'won' ? 'Won ✅' : 'Lost ❌'} | ` +
            'Your first score this trial is already recorded. Play again for practice, but only your first score counts.'
          );
        }
      } else {
        setStatus(
          `Result: Close ${outcome === 'won' ? 'Won ✅' : 'Lost ❌'} | ` +
          'Enter your name above and click "Save Last Score to Leaderboard" to record it. ' +
          'Your first score of the week is locked in. Play again for practice, but only your first score counts.'
        );
      }
    }

    function handleOptionClick(option) {
      repTurns++;

      addMessage('You: ' + option.label.replace(/^[“"]/, '').replace(/[”"]$/, ''), 'rep');
      if (option.customerReply) {
        addMessage(option.customerReply, 'customer');
      }
      if (option.coach) {
        addMessage('Coach: ' + option.coach, 'system');
      }

      qualityPoints += option.points || 0;
      if (option.type === 'best') strongMoves++;

      if (option.outcome === 'won') {
        addMessage('Outcome: CLOSE WON – You guided the customer to a clear decision.', 'outcome');
        endScenario('won');
        return;
      }
      if (option.outcome === 'lost') {
        addMessage('Outcome: CLOSE LOST – The opportunity ended without moving forward.', 'outcome');
        endScenario('lost');
        return;
      }

      if (option.next) {
        renderState(option.next);
      }
    }

    function startScenario() {
      conversationEl.innerHTML = '';
      optionsEl.innerHTML = '';
      qualityPoints = 0;
      strongMoves = 0;
      repTurns = 0;
      lastScore = null;
      lastOutcome = null;
      saveScoreBtn.disabled = true;

      const now = new Date();
      const trialInfo = getTrialInfo(now);
      weekLabelEl.textContent =
        'Current Trial: ' + formatDateShort(trialInfo.start) + ' – ' +
        formatDateShort(trialInfo.end) + ' (Fri–Thu)';

      scenarioTitleEl.textContent = scenario.title;
      scenarioDescriptionEl.textContent = scenario.description;

      renderState(scenario.startState);
      setStatus('Goal: Move through the conversation using STAR skills. Your choices affect the outcome and your score.');
      renderLeaderboard();
    }

    // Save score after the fact
    saveScoreBtn.addEventListener('click', () => {
      if (lastScore === null || lastOutcome === null) {
        alert('Play through a scenario first to generate a score.');
        return;
      }
      const name = playerNameInput.value.trim();
      if (!name) {
        alert('Please enter your name before saving your score.');
        return;
      }
      const accepted = recordScore(name, lastScore, lastOutcome);
      saveScoreBtn.disabled = true;
      if (accepted) {
        setStatus(
          `Score saved to leaderboard as: ${name}. ` +
          'Your first score of the week is locked in. Play again for practice, but only your first score counts.'
        );
      } else {
        setStatus(
          'Your first score this trial is already recorded. Play again for practice, but only your first score counts.'
        );
      }
    });

    resetBtn.addEventListener('click', () => {
      startScenario();
    });

    // Init
    startScenario();
  </script>
</body>
</html>